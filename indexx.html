<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CBE Unified Analytics Terminal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { --cbe-blue: #003366; --cbe-gold: #c5a059; --slate: #1e293b; }
        body { font-family: 'Inter', system-ui, sans-serif; background: #f8fafc; margin: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* Navigation */
        .navbar { background: var(--cbe-blue); color: white; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; height: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { padding: 8px 16px; border-radius: 4px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-gold { background: var(--cbe-gold); color: white; margin-right: 10px; }

        /* Split Layout */
        .main-content { display: flex; flex: 1; overflow: hidden; }
        
        /* Left Panel: Extracted Tables */
        .data-panel { flex: 1; overflow-y: auto; padding: 20px; border-right: 2px solid #e2e8f0; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        .card-header { padding: 12px 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-weight: bold; color: var(--cbe-blue); font-size: 14px; }
        
        /* Right Panel: PDF Viewer */
        .pdf-panel { flex: 1; background: #525659; display: flex; flex-direction: column; }
        iframe { width: 100%; height: 100%; border: none; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { text-align: left; padding: 10px; background: #f1f5f9; color: #64748b; text-transform: uppercase; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
        .num { font-family: 'JetBrains Mono', monospace; text-align: right; font-weight: 600; }
        
        #log { font-size: 11px; color: #ef4444; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: bold; font-size: 18px;">CBE Financial Dashboard</div>
    <div>
        <button class="btn btn-gold" onclick="toggleFX()">üí∞ Live Exchange Rates</button>
    </div>
</div>

<div class="main-content">
    <div class="data-panel">
        <div id="log">Status: Initializing Scanner...</div>
        
        <div id="fx-section" class="card" style="display:none; border-top: 4px solid var(--cbe-gold);">
            <div class="card-header">Live Market Rates (EGP)</div>
            <table id="fx-table">
                <thead><tr><th>Currency</th><th>Pair</th><th>Buy</th><th>Sell</th></tr></thead>
                <tbody id="fx-body"></tbody>
            </table>
        </div>

        <div id="table-output"></div>
    </div>

    <div class="pdf-panel">
        <iframe src="yoo.pdf#view=FitH" title="PDF Source"></iframe>
    </div>
</div>

<script>
    const PDF_PATH = 'yoo.pdf';
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    async function toggleFX() {
        const sect = document.getElementById('fx-section');
        sect.style.display = sect.style.display === 'none' ? 'block' : 'none';
        if(sect.style.display === 'block') {
            const sym = {'USD':'üá∫üá∏','EUR':'üá™üá∫','JPY':'üáØüáµ','GBP':'üá¨üáß','CHF':'üá®üá≠','SAR':'üá∏üá¶','AED':'üá¶üá™'};
            const res = await fetch('https://open.er-api.com/v6/latest/USD');
            const data = await res.json();
            let html = '';
            for(let [c, flag] of Object.entries(sym)) {
                let rate = (data.rates.EGP / data.rates[c]).toFixed(4);
                html += `<tr><td>${flag} ${c}</td><td>${c}/EGP</td><td class="num">${(rate*0.998).toFixed(4)}</td><td class="num">${(rate*1.002).toFixed(4)}</td></tr>`;
            }
            document.getElementById('fx-body').innerHTML = html;
        }
    }

    async function extractData() {
        const log = document.getElementById('log');
        const output = document.getElementById('table-output');
        
        try {
            log.innerText = "‚è≥ Loading yoo.pdf from server...";
            const loadingTask = pdfjsLib.getDocument(PDF_PATH);
            const pdf = await loadingTask.promise;
            log.innerText = `‚úÖ PDF Loaded. Parsing ${pdf.numPages} pages for tables...`;

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const text = await page.getTextContent();
                
                // Group text by vertical position (Y-coordinate)
                const rows = {};
                text.items.forEach(item => {
                    const y = Math.round(item.transform[5]);
                    if (!rows[y]) rows[y] = [];
                    rows[y].push({ x: item.transform[4], str: item.str.trim() });
                });

                let tableRows = "";
                Object.keys(rows).sort((a,b) => b-a).forEach(y => {
                    const line = rows[y].sort((a,b) => a.x - b.x);
                    const lineStr = line.map(it => it.str).join(" ");
                    
                    // Filter: We want rows that have a label AND at least 2 numbers
                    const numbers = line.filter(it => /^-?[\d,.]+(\(.*\))?$/.test(it.str) && it.str.length > 1);
                    if (numbers.length >= 2 && /[A-Za-z]/.test(lineStr)) {
                        tableRows += `<tr>
                            <td style="font-weight:600; color:#334155">${lineStr.replace(/[0-9,.( )]{2,}/g, '').trim()}</td>
                            <td class="num">${numbers[0].str}</td>
                            <td class="num">${numbers[numbers.length-1].str}</td>
                        </tr>`;
                    }
                });

                if (tableRows) {
                    output.innerHTML += `
                        <div class="card">
                            <div class="card-header">Statistical Data - Page ${i}</div>
                            <table>
                                <thead><tr><th>Category</th><th>Previous</th><th>Current</th></tr></thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>`;
                }
            }
            log.innerText = "‚ú® Extraction Complete. All tables rendered below.";
        } catch (err) {
            log.innerText = "‚ùå ERROR: Cannot access yoo.pdf. Ensure the file is named exactly 'yoo.pdf' on GitHub.";
            console.error(err);
        }
    }

    window.onload = extractData;
</script>
</body>
</html>