<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CBE Dynamic Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --cbe: #003366; --gold: #c5a059; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f1f5f9; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Nav & Controls */
        .nav { background: var(--cbe); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .control-bar { background: #fff; padding: 10px 25px; display: flex; gap: 10px; border-bottom: 1px solid #ddd; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 13px; }
        .btn-gold { background: var(--gold); color: white; }
        .btn-outline { background: white; border: 1px solid var(--cbe); color: var(--cbe); }

        .main { display: flex; flex: 1; overflow: hidden; }
        .data-pane { flex: 1; overflow-y: auto; padding: 20px; }
        .pdf-pane { flex: 1; background: #525659; display: none; } /* Hidden by default */
        iframe { width: 100%; height: 100%; border: none; }

        /* Panels */
        .panel-card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid var(--gold); }
        .range-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; align-items: end; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 12px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td, th { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .num { font-family: monospace; text-align: right; font-weight: bold; }
    </style>
</head>
<body>

<div class="nav">
    <div style="font-weight: bold;">CBE Analytics Terminal</div>
    <div id="status" style="font-size: 12px; opacity: 0.8;">Ready</div>
</div>

<div class="control-bar">
    <button class="btn btn-outline" onclick="window.open('yoo.pdf')">üìë Pop-out PDF</button>
    <button class="btn btn-outline" onclick="togglePDF()">üëÅÔ∏è Toggle PDF View</button>
    <button class="btn btn-gold" onclick="togglePanel('fx-panel')">üí∞ FX Table</button>
    <button class="btn btn-gold" onclick="togglePanel('map-panel')">üó∫Ô∏è Trend Map</button>
</div>

<div class="main">
    <div class="data-pane">
        
        <div id="fx-panel" class="panel-card" style="display:none;">
            <h3 style="margin-top:0; color:var(--cbe)">Live Exchange Rates</h3>
            <table id="fx-table">
                <thead><tr><th>Currency</th><th>Pair</th><th>Rate</th></tr></thead>
                <tbody id="fx-body"></tbody>
            </table>
        </div>

        <div id="map-panel" class="panel-card" style="display:none;">
            <h3 style="margin-top:0; color:var(--cbe)">Historical Variation Analysis</h3>
            <div class="range-controls">
                <div>
                    <label>Currency:</label><br>
                    <select id="curSel" onchange="updateTrend()"><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="SAR">SAR</option></select>
                </div>
                <div>
                    <label>From:</label><br>
                    <select id="startMonth" onchange="updateTrend()"><option value="0">Jan 2022</option><option value="12">Jan 2023</option><option value="24">Jan 2024</option><option value="36">Jan 2025</option></select>
                </div>
                <div>
                    <label>To:</label><br>
                    <select id="endMonth" onchange="updateTrend()"><option value="11">Dec 2022</option><option value="23">Dec 2023</option><option value="35">Dec 2024</option><option value="47" selected>Today (Dec 2025)</option></select>
                </div>
                <div id="varResult" style="font-weight:bold; color:red; padding-bottom:10px;">Var: --%</div>
            </div>
            <canvas id="trendChart" height="150"></canvas>
        </div>

        <div id="extracted-data"></div>
    </div>

    <div class="pdf-pane" id="pdf-container">
        <iframe src="yoo.pdf"></iframe>
    </div>
</div>

<script>
    // 1. UI Toggles
    function togglePDF() {
        const p = document.getElementById('pdf-container');
        p.style.display = (p.style.display === 'none' || p.style.display === '') ? 'block' : 'none';
    }

    function togglePanel(id) {
        const p = document.getElementById(id);
        p.style.display = p.style.display === 'none' ? 'block' : 'none';
        if(id === 'fx-panel') loadFX();
        if(id === 'map-panel') updateTrend();
    }

    // 2. FX Live Table
    async function loadFX() {
        const res = await fetch('https://open.er-api.com/v6/latest/USD');
        const d = await res.json();
        const egp = d.rates.EGP;
        const cur = ['USD','EUR','GBP','JPY','CHF','SAR','AED'];
        let html = '';
        cur.forEach(c => {
            let r = (egp / d.rates[c]).toFixed(2);
            html += `<tr><td>${c}</td><td>${c}/EGP</td><td class="num">${r}</td></tr>`;
        });
        document.getElementById('fx-body').innerHTML = html;
    }

    // 3. Trend Map with Date Range Logic
    let chart = null;
    const historicalData = {
        'USD': Array.from({length: 48}, (_, i) => 15.7 + (i * 0.72)), // Simulated trend Jan 22 - Dec 25
        'EUR': Array.from({length: 48}, (_, i) => 17.8 + (i * 0.76)),
        'SAR': Array.from({length: 48}, (_, i) => 4.18 + (i * 0.19))
    };

    function updateTrend() {
        const cur = document.getElementById('curSel').value;
        const start = parseInt(document.getElementById('startMonth').value);
        const end = parseInt(document.getElementById('endMonth').value);
        
        const fullData = historicalData[cur] || historicalData['USD'];
        const slice = fullData.slice(start, end + 1);
        const labels = Array.from({length: slice.length}, (_, i) => `M${start + i + 1}`);

        const varCalc = (((slice[slice.length-1] - slice[0]) / slice[0]) * 100).toFixed(1);
        document.getElementById('varResult').innerText = `Variation: +${varCalc}%`;

        if(chart) chart.destroy();
        chart = new Chart(document.getElementById('trendChart'), {
            type: 'line',
            data: { labels: labels, datasets: [{ label: cur + ' Trend', data: slice, borderColor: '#c5a059', fill: true, backgroundColor: 'rgba(197,160,89,0.1)' }]},
            options: { plugins: { legend: { display: false } } }
        });
    }

    // 4. PDF Auto-Scraper (Always runs for the tables)
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    async function scrape() {
        try {
            const pdf = await pdfjsLib.getDocument('yoo.pdf').promise;
            let output = '';
            for(let i=1; i<=pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const text = await page.getTextContent();
                let rows = {};
                text.items.forEach(it => {
                    let y = Math.round(it.transform[5]);
                    if(!rows[y]) rows[y] = [];
                    rows[y].push(it.str);
                });
                let table = '<table>';
                Object.keys(rows).sort((a,b)=>b-a).forEach(y => {
                    let line = rows[y].join(" ");
                    if(/[0-9]/.test(line) && line.length > 10) {
                        table += `<tr><td>${line}</td></tr>`;
                    }
                });
                output += `<div class="panel-card"><h4>Page ${i} Data</h4>${table}</table></div>`;
            }
            document.getElementById('extracted-data').innerHTML = output;
        } catch(e) { console.log("PDF not found yet"); }
    }
    window.onload = scrape;
</script>
</body>
</html>
