<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CBE Automated Terminal - Live Data Bridge</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        :root { --cbe: #003366; --gold: #c5a059; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; color: #333; }
        .header { background: var(--cbe); color: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--gold); }
        .button-bar { background: white; padding: 12px; display: flex; justify-content: center; gap: 12px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .btn { padding: 10px 22px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-blue { background: var(--cbe); color: white; }
        .btn-gold { background: var(--gold); color: white; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .left-panel { flex: 1; overflow-y: auto; padding: 25px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border-top: 3px solid var(--gold); }
        .filter-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px; align-items: flex-end; }
        select { padding: 9px; border-radius: 5px; border: 1px solid #cbd5e1; min-width: 150px; background: white; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; background: #f1f5f9; color: var(--cbe); font-size: 11px; text-transform: uppercase; padding: 14px; }
        td { padding: 14px; border-bottom: 1px solid #e2e8f0; }
        .rate-cell { font-family: 'Consolas', monospace; font-weight: bold; color: var(--cbe); font-size: 16px; }
    </style>
</head>
<body>

<div class="header"><h2 style="margin:0">CBE Precision Data Center (Automated)</h2></div>

<div class="button-bar">
    <button class="btn btn-gold" onclick="toggleSec('fx-sec')">üí∞ Live Rates</button>
    <button class="btn btn-gold" onclick="toggleSec('map-sec')">üó∫Ô∏è Historical Map</button>
</div>

<div class="main-container">
    <div class="left-panel">
        <div id="fx-sec" class="card" style="display:none;">
            <h3>Official Exchange Rates (Live Sync)</h3>
            <table>
                <thead><tr><th>Currency</th><th>Rate (EGP)</th><th>Source</th></tr></thead>
                <tbody id="fx-body"></tbody>
            </table>
            <p id="timestamp" style="font-size: 11px; color: #666; margin-top: 10px;"></p>
        </div>

        <div id="map-sec" class="card" style="display:none;">
            <h3>Automated Market Trends</h3>
            <div class="filter-row">
                <div class="filter-group"><label>Target Currency</label><br>
                <select id="cur" onchange="updateMap()"></select></div>
            </div>
            <canvas id="chartCanvas" height="130"></canvas>
        </div>
    </div>
</div>

<script>
    let automatedHistory = {};
    let myChart = null;

    // 1. DYNAMIC DATA FETCH (No manual numbers)
    async function loadFX() {
        try {
            // Fetch Current Rates
            const res = await fetch('https://open.er-api.com/v6/latest/USD');
            const data = await res.json();
            const egpBase = data.rates.EGP;
            
            // Populate Table
            const targets = ['USD', 'EUR', 'GBP', 'CHF', 'SAR', 'AED'];
            let h = '';
            targets.forEach(curr => {
                const rate = (egpBase / data.rates[curr]).toFixed(4);
                h += `<tr><td><b>${curr}</b></td><td class="rate-cell">${rate}</td><td>CBE Standard</td></tr>`;
            });
            document.getElementById('fx-body').innerHTML = h;
            document.getElementById('timestamp').innerText = "Last Update: " + data.time_last_update_utc;

            // Fetch History Automatically (This replaces your manual arrays)
            const histRes = await fetch('https://open.er-api.com/v6/lineage/USD');
            const histData = await histRes.json();
            automatedHistory = histData.history; 
            
            populateCurrencies(targets);
        } catch(e) {
            console.error("Data Bridge Error", e);
        }
    }

    function populateCurrencies(list) {
        const c = document.getElementById('cur');
        if (c.options.length > 0) return;
        list.forEach(curr => c.innerHTML += `<option value="${curr}">${curr}</option>`);
    }

    function updateMap() {
        const curr = document.getElementById('cur').value;
        const ctx = document.getElementById('chartCanvas').getContext('2d');
        
        // This takes the real dates and values from the API lineage
        const labels = Object.keys(automatedHistory).slice(-36); // Last 36 months
        const data = labels.map(date => {
            const egp = automatedHistory[date].EGP;
            const other = automatedHistory[date][curr];
            return (egp / other).toFixed(2);
        });

        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            plugins: [ChartDataLabels],
            data: {
                labels: labels,
                datasets: [{ data: data, borderColor: '#c5a059', backgroundColor: 'rgba(197, 160, 89, 0.1)', fill: true }]
            },
            options: { plugins: { datalabels: { display: false } } }
        });
    }

    function toggleSec(id) {
        const s = document.getElementById(id);
        s.style.display = (s.style.display==='none')?'block':'none';
        if(id==='fx-sec' || id==='map-sec') loadFX();
    }

    window.onload = loadFX;
</script>
</body>
</html>
