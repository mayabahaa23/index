<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CBE Precision Terminal - Official 2025 Rates</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        :root { --cbe: #003366; --gold: #c5a059; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; color: #333; }
        
        /* Header & Navigation */
        .header { background: var(--cbe); color: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--gold); }
        .button-bar { background: white; padding: 12px; display: flex; justify-content: center; gap: 12px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        
        .btn { padding: 10px 22px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-blue { background: var(--cbe); color: white; }
        .btn-gold { background: var(--gold); color: white; }

        /* Main Layout */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .left-panel { flex: 1; overflow-y: auto; padding: 25px; }
        .right-panel { flex: 1; background: #525659; display: none; } 
        iframe { width: 100%; height: 100%; border: none; }

        /* UI Components */
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border-top: 3px solid var(--gold); }
        .filter-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px; align-items: flex-end; }
        
        select { padding: 9px; border-radius: 5px; border: 1px solid #cbd5e1; min-width: 150px; background: white; }
        #varDisplay { font-size: 24px; font-weight: bold; color: #dc2626; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; background: #f1f5f9; color: var(--cbe); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
        td, th { padding: 14px; border-bottom: 1px solid #e2e8f0; }
        .rate-cell { font-family: 'Consolas', monospace; font-weight: bold; color: var(--cbe); font-size: 16px; }

        /* Year/Month Menu */
        #year-menu { display:none; position:absolute; top:45px; left:0; z-index:1000; min-width:300px; border:1px solid #ddd; padding: 15px; background: white; }
        #month-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-top:10px; }
        .month-btn { padding: 8px; font-size: 11px; background: #f1f5f9; border: 1px solid #ddd; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .month-btn:hover { background: var(--gold); color: white; }
        
        /* Table Styles for Scraped Data */
        .scraped-table { font-size: 12px; margin-top: 10px; border: 1px solid #e2e8f0; }
        .scraped-table td { padding: 6px; border: 1px solid #cbd5e1; }
    </style>
</head>
<body>

<div class="header"><h2 style="margin:0">CBE Precision Data Center</h2></div>

<div class="button-bar">
    <button class="btn btn-blue" id="popup-btn" onclick="openCurrentPDF()">üìë 1. Pop-up PDF (<span id="file-label">None</span>)</button>
    <div style="display:inline-block; position:relative;">
        <button class="btn btn-blue" onclick="toggleYearMenu()">üëÅÔ∏è 2. Web PDF View</button>
        <div id="year-menu" class="card">
            <div style="display:flex; gap:10px; justify-content: center;">
                <button class="btn btn-gold" onclick="showMonths('2024')">2024</button>
                <button class="btn btn-gold" onclick="showMonths('2025')">2025</button>
            </div>
            <div id="month-grid"></div>
        </div>
    </div>
    <button class="btn btn-gold" onclick="toggleSec('fx-sec')">üí∞ 3. Live FX Table</button>
    <button class="btn btn-gold" onclick="toggleSec('map-sec')">üó∫Ô∏è 4. Market Trends</button>
</div>

<div class="main-container">
    <div class="left-panel">
        <div id="fx-sec" class="card" style="display:none;">
            <h3>Official Exchange Rates (CBE Reference)</h3>
            <table id="fx-table">
                <thead><tr><th>Currency</th><th>Rate (EGP)</th><th>Status</th></tr></thead>
                <tbody id="fx-body"></tbody>
            </table>
            <p id="timestamp" style="font-size: 11px; color: #666; margin-top: 10px;"></p>
        </div>

        <div id="map-sec" class="card" style="display:none;">
            <h3>Strategic Trend Analysis</h3>
            <div class="filter-row">
                <div class="filter-group"><label>Currency</label><br><select id="cur" onchange="updateMap()"></select></div>
                <div class="filter-group"><label>From</label><br><select id="start" onchange="updateMap()"></select></div>
                <div class="filter-group"><label>To</label><br><select id="end" onchange="updateMap()"></select></div>
                <div class="filter-group"><label>Period Var.</label><div id="varDisplay">0%</div></div>
            </div>
            <canvas id="chartCanvas" height="130"></canvas>
        </div>

        <div id="pdf-data"></div>
    </div>

    <div class="right-panel" id="pdf-panel">
        <iframe id="pdf-frame" src=""></iframe>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let currentFile = ""; 
    let pdfDataPoints = [];
    let pdfLabels = [];
    let myChart = null;

    // Data Sources
    const cbeOfficial = { 'USD': 47.531, 'EUR': 56.001, 'GBP': 64.276, 'CHF': 60.336, 'SAR': 12.672, 'AED': 12.939, 'JPY': 0.304 };
    const ratesArchive = {
        USD: [15.7, 15.7, 15.7, 18.3, 18.5, 18.7, 18.9, 19.1, 19.3, 19.6, 24.2, 24.7, 29.8, 30.5, 30.8, 30.9, 30.9, 30.9, 30.9, 30.9, 30.9, 30.9, 30.9, 30.9, 30.9, 30.9, 47.5, 48.2, 47.9, 47.5, 48.1, 48.5, 48.3, 48.1, 49.2, 49.5, 48.8, 48.5, 48.2, 47.9, 47.5, 47.2, 47.4, 47.6, 47.3, 47.2, 47.1, 47.4],
        EUR: [17.8, 17.7, 17.5, 19.8, 19.6, 19.7, 19.2, 19.1, 19.0, 19.3, 24.5, 26.1, 31.5, 32.4, 33.1, 33.7, 33.5, 33.8, 34.2, 33.9, 33.2, 33.6, 33.8, 34.1, 33.9, 33.5, 51.5, 52.3, 51.8, 51.2, 52.1, 52.8, 53.4, 53.1, 52.5, 52.2, 52.8, 52.4, 53.1, 53.9, 54.2, 54.5, 54.7, 54.9, 55.1, 55.0, 54.8, 55.0],
        // ... (Keep other currencies from your original list)
    };

    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const fullTimeline = [];
    [2022, 2023, 2024, 2025].forEach(y => monthNames.forEach(m => fullTimeline.push(`${m} ${y}`)));

    // --- 1. FIXED: Live FX Table Logic ---
    function loadFX() {
        const tbody = document.getElementById('fx-body');
        tbody.innerHTML = '';
        Object.entries(cbeOfficial).forEach(([curr, rate]) => {
            const row = `<tr>
                <td><b>${curr}</b></td>
                <td class="rate-cell">${rate.toFixed(3)}</td>
                <td><span style="color:green">‚óè Official</span></td>
            </tr>`;
            tbody.innerHTML += row;
        });
        document.getElementById('timestamp').innerText = "Last Updated: " + new Date().toLocaleString();
    }

    // --- 2. FIXED: Market Trends Map Logic ---
    function updateMap() {
        const cur = document.getElementById('cur').value;
        const startIndex = parseInt(document.getElementById('start').value);
        const endIndex = parseInt(document.getElementById('end').value);

        if (startIndex >= endIndex) {
            document.getElementById('varDisplay').innerText = "Range Error";
            return;
        }

        const dataSlice = ratesArchive[cur].slice(startIndex, endIndex + 1);
        const labelSlice = fullTimeline.slice(startIndex, endIndex + 1);

        // Calculate Variation %
        const first = dataSlice[0];
        const last = dataSlice[dataSlice.length - 1];
        const variation = (((last - first) / first) * 100).toFixed(2);
        
        const varEl = document.getElementById('varDisplay');
        varEl.innerText = (variation > 0 ? "+" : "") + variation + "%";
        varEl.style.color = variation > 0 ? "#dc2626" : "#16a34a"; // Red for up, Green for down

        // Draw Chart
        const ctx = document.getElementById('chartCanvas').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labelSlice,
                datasets: [{
                    label: `${cur} Trend (Historical)`,
                    data: dataSlice,
                    borderColor: '#003366',
                    backgroundColor: 'rgba(0,51,102,0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: false } }
            }
        });
    }

    // --- Navigation & Helper Functions ---
    function toggleSec(id) { 
        const s = document.getElementById(id); 
        const isHidden = s.style.display === 'none';
        s.style.display = isHidden ? 'block' : 'none'; 
        
        if (isHidden) {
            if(id === 'fx-sec') loadFX(); 
            if(id === 'map-sec') updateMap(); 
        }
    }

    function toggleYearMenu() { 
        const m = document.getElementById('year-menu'); 
        m.style.display = (m.style.display === 'block') ? 'none' : 'block'; 
    }

    function showMonths(year) {
        const grid = document.getElementById('month-grid');
        grid.innerHTML = '';
        monthNames.forEach(m => {
            const btn = document.createElement('button');
            btn.className = 'month-btn';
            btn.innerText = m;
            
            // File Mapping logic
            let f = `${year}-${m}.pdf`;
            if (year === '2025') {
                const map = {Dec:'yoo.pdf', Nov:'novv.pdf', Jan:'jann.pdf' /* ... add others */};
                f = map[m] || f;
            }

            btn.onclick = () => { 
                currentFile = f;
                document.getElementById('file-label').innerText = f;
                loadSpecificPDF(f); 
                toggleYearMenu(); 
            };
            grid.appendChild(btn);
        });
    }

    async function loadSpecificPDF(f) {
        const panel = document.getElementById('pdf-panel');
        const frame = document.getElementById('pdf-frame');
        frame.src = f;
        panel.style.display = 'block';
    }

    function populateDropdowns() {
        const s = document.getElementById('start'), 
              e = document.getElementById('end'), 
              c = document.getElementById('cur');
        
        fullTimeline.forEach((m, i) => {
            s.innerHTML += `<option value="${i}">${m}</option>`;
            e.innerHTML += `<option value="${i}" ${i==47?'selected':''}>${m}</option>`;
        });
        Object.keys(ratesArchive).forEach(curr => c.innerHTML += `<option value="${curr}">${curr}</option>`);
    }

    window.onload = () => { populateDropdowns(); };
</script>
</body>
</html>



